---
# Since i need to use the facts from webserver1 in database server, i need to collect it, so i use delegate_to and delegate_facts
# I use the when condition to make sure that the task is only executed on the dbserver1 host
- name: Gather webserver1 facts
  ansible.builtin.setup:
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ groups['webservers'] }}"
  when: inventory_hostname == 'dbserver1'
  tags: facts

- name: Install mariadb-server and MySQL-python
  ansible.builtin.import_tasks: packages.yml
  tags: packages

- name: Start and enable mariadb
  ansible.builtin.import_tasks: service.yml
  tags: service

- name: Create database "webappdb"
  community.mysql.mysql_db:
    name: webappdb
    state: present
  tags: db

# Incase i have multiple webserver, i need to create a user for each webserver, so i use the loop module
# I use the when condition to make sure that the task is only executed on the dbserver1 host
- name: Create user "web-app"
  community.mysql.mysql_user:
    name: web-app
    password: "{{ common_db_configuration.dbpass }}"
    priv: "webappdb.*:ALL,GRANT"
    host: "{{ hostvars[item]['ansible_facts']['eth1']['ipv4']['address'] }}"
    state: present
  loop: "{{ groups['webservers'] }}"
  when: inventory_hostname == 'dbserver1'
  tags: db
